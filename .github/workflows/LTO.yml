name: Compile Realme SM4250 Kernel with LTO

on:
  push:
    branches:
      - stable

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v3
        with:
          repository: Ponleuz12/kernel_realme_sm4250
          ref: stable

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git bc bison flex libssl-dev make python3 \
            gcc-aarch64-linux-gnu clang lld cpio

      - name: Set Up Toolchain
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git toolchain
          export PATH=$PWD/toolchain/bin:$PATH

      - name: Configure Kernel Build
        run: |
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CC=clang
          export LD=ld.lld
          make O=out sm4250_defconfig
          # Enable LTO
          sed -i 's/# CONFIG_LTO_CLANG is not set/CONFIG_LTO_CLANG=y/' out/.config
          sed -i 's/# CONFIG_THINLTO is not set/CONFIG_THINLTO=y/' out/.config

      - name: Build Kernel
        run: make O=out -j$(nproc)

      - name: Package Kernel
        run: |
          mkdir -p kernel-package
          cp out/arch/arm64/boot/Image.gz-dtb kernel-package/
          cp out/.config kernel-package/config
          # Add other files as needed (e.g., modules, dtb)

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: kernel-build
          path: kernel-package/

      - name: Verify Build
        run: ls -lh kernel-package/
