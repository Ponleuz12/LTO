#!/bin/bash

set -e

REPO_NAME=$1
REPO_URL=$2
REPO_BRANCH=$3
DEFCONFIG=$4

echo ">>> Cloning kernel source: $REPO_NAME"
git clone --depth=1 -b "$REPO_BRANCH" "$REPO_URL" "$REPO_NAME"
cd "$REPO_NAME"

echo ">>> Setting up Clang"
CLANG_DIR=../clang
export PATH="$CLANG_DIR/bin:$PATH"

echo ">>> Building with defconfig: $DEFCONFIG"
export ARCH=arm64
export SUBARCH=arm64
export KBUILD_BUILD_USER=Ponleuz
export KBUILD_BUILD_HOST=GitHub

make O=out ARCH=arm64 $DEFCONFIG

make -j$(nproc) O=out ARCH=arm64 \
  CC=clang \
  LD=ld.lld \
  AR=llvm-ar \
  NM=llvm-nm \
  OBJCOPY=llvm-objcopy \
  OBJDUMP=llvm-objdump \
  STRIP=llvm-strip \
  READELF=llvm-readelf \
  HOSTLD=ld.lld \
  HOSTCC=clang

echo ">>> Kernel build finished"
cp out/arch/arm64/boot/Image.gz-dtb ../output/
