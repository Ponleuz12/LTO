name: Android Kernel Builder (ThinLTO)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: ðŸ“¥ Checkout Builder
      uses: actions/checkout@v3

    - name: ðŸ“¥ Clone Clang (AOSP)
      run: |
        mkdir clang
        curl -L https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/master/clang-r450784d.tar.gz \
          -o clang.tar.gz
        tar -xf clang.tar.gz -C clang

    - name: ðŸ›  Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential cpio curl flex git libncurses-dev \
          libssl-dev python3 unzip zip zstd jq

    - name: ðŸ”ƒ Parse Repos & Build All
      run: |
        mkdir -p output
        repos=$(cat repos.json | jq -c '.[]')
        for repo in $repos; do
          NAME=$(echo $repo | jq -r .name)
          URL=$(echo $repo | jq -r .repo)
          BRANCH=$(echo $repo | jq -r .branch)
          DEFCONFIG=$(echo $repo | jq -r .defconfig)
          bash build.sh "$NAME" "$URL" "$BRANCH" "$DEFCONFIG"
        done

    - name: ðŸ“¦ Package All Kernels
      run: |
        cd output
        zip -r9 Kernel-ThinLTO-Builds.zip *

    - name: ðŸ“¤ Upload Kernel ZIP
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-ThinLTO-Builds
        path: output/Kernel-ThinLTO-Builds.zip
